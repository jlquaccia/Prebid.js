<html>

<head>
  <!--
    FLEDGE (Protected Audience API) configuration with GPT and FLEDGE-supporting adapter

    gulp serve --modules=fledgeForGpt,openxBidAdapter
  -->
  <script async src="../../build/dev/prebid.js"></script>
  <script async src="https://www.googletagservices.com/tag/js/gpt.js"></script>
  <script>
    var FAILSAFE_TIMEOUT = 3000;
    var PREBID_TIMEOUT = 1500;

    var pbjs = pbjs || {};
    pbjs.que = pbjs.que || [];

    var googletag = googletag || {};
    googletag.cmd = googletag.cmd || [];

    googletag.cmd.push(function () {
      googletag.pubads().disableInitialLoad();
    });

    var adUnits = [{
      code: 'Div2',
      mediaTypes: {
        banner: { sizes: [300, 250] }
      },
      bids: [
        {
          bidder: 'pubmatic',
          params: {
            publisherId: '164074',
            adSlot: '      /43743431/owfledge   ',
            pmzoneid: 'zone2',
            kadpageurl: 'http://www.microsoft.com/key1=1&key2=2&fledge_type=1',
            // deals: ["PM-GNOD-0698"]
          }
        }
      ],
      ortb2Imp: {
        ext: {
          ae: 1
        }
      }
    }];

    pbjs.que.push(function () {
      pbjs.setConfig({
        paapi: {
          enabled: true,
          gpt: {
            autoconfig: false
          }
        },
        debug: true
      });

      pbjs.setBidderConfig({
        bidders: ['pubmatic'],
        config: {
          fledgeEnabled: true
        }
      });

      pbjs.addAdUnits(adUnits);

      pbjs.requestBids({
        bidsBackHandler: sendAdserverRequest,
        timeout: PREBID_TIMEOUT
      });

      function sendAdserverRequest() {
        if (pbjs.adserverRequestSent) return;
        pbjs.adserverRequestSent = true;
        googletag.cmd.push(function () {
          pbjs.que.push(function () {
            pbjs.setTargetingForGPTAsync();
            pbjs.setPAAPIConfigForGPT();
            googletag.pubads().refresh();
          });
        });
      }

      setTimeout(function () {
        sendAdserverRequest();
      }, FAILSAFE_TIMEOUT);
    });

    googletag.cmd.push(function () {
      // googletag
      //   .defineSlot('/19968336/header-bid-tag-0', adUnits[0].mediaTypes.banner.sizes, 'div-gpt-ad-1460505748561-0')
      //   .addService(googletag.pubads());
      googletag.defineSlot('/43743431/owfledge', [300, 250], 'Div2').addService(googletag.pubads());

      googletag.pubads().enableSingleRequest();
      googletag.enableServices();
    });
  </script>
</head>

<body>
  <h2>Prebid.js FLEDGE+GPT Example</h2>

  <!-- <h5>Div-1</h5>
  <div id='div-gpt-ad-1460505748561-0'>
    <script type='text/javascript'>
      googletag.cmd.push(function () { googletag.display('div-gpt-ad-1460505748561-0'); });
    </script>
  </div> -->
  <div id='Div2'>
    <script type='text/javascript'>
      googletag.cmd.push(function () {
        googletag.display('Div2');
      });
    </script>
  </div>
</body>

</html>