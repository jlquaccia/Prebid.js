<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Video Test</title>
  <!-- <script async src="//cdn.jsdelivr.net/npm/prebid.js@latest/dist/not-for-prod/prebid.js"></script> -->
  <script async src="../../build/dev/prebid.js"></script>
  <script>
    var pbjs = pbjs || {};
    pbjs.que = pbjs.que || [];

    var tempTag = false;
    var invokeVideoPlayer = function(url) {
      tempTag = url;
    }

    var videoAdUnit1 = {
      code: 'video1',
      mediaTypes: {
        video: {
          context: 'instream',
          playerSize: [640, 480],
          mimes: ['video/mp4'],
          protocols: [1, 2, 3, 4, 5, 6, 7, 8],
          playbackmethod: [2],
          skip: 1
        }
      },
      bids: [{
        bidder: 'appnexus',
        params: {
          placementId: 13232361
        }
      }]
    };

    var videoAdUnit2 = {
      code: 'video2',
      mediaTypes: {
        video: {
          context: 'instream',
          playerSize: [640, 480],
          mimes: ['video/mp4'],
          protocols: [1, 2, 3, 4, 5, 6, 7, 8],
          playbackmethod: [2],
          skip: 1
        }
      },
      bids: [{
        bidder: 'appnexus',
        params: {
          placementId: 13232361
        }
      }]
    };

    var videoAdUnit3 = {
      code: 'video3',
      mediaTypes: {
        video: {
          context: 'instream',
          playerSize: [640, 480],
          mimes: ['video/mp4'],
          protocols: [1, 2, 3, 4, 5, 6, 7, 8],
          playbackmethod: [2],
          skip: 1
        }
      },
      bids: [{
        bidder: 'appnexus',
        params: {
          placementId: 13232361
        }
      }]
    };

    pbjs.que.push(function() {
      pbjs.addAdUnits(videoAdUnit1);
      pbjs.addAdUnits(videoAdUnit2);
      pbjs.addAdUnits(videoAdUnit3);
      pbjs.setConfig({
        debug: false,
        cache: {
          url: 'https://prebid.adnxs.com/pbc/v1/cache',
          batchSize: 1,
          batchTimeout: 20
        }
      });
      pbjs.requestBids({
        bidsBackHandler: function(bids) {
          console.log(Object.keys(bids));
          console.log(bids);
          const elementIdsArray = Object.keys(bids);
          let elId;

          if (elementIdsArray.indexOf('video1') !== -1) {
            elId = 'video1';
            var videoUrl = pbjs.adServers.dfp.buildVideoUrl({
              adUnit: videoAdUnit1,
              params: {
                iu: '/19968336/prebid_cache_video_adunit',
                cust_params: {
                  section: 'blog',
                  anotherKey: 'anotherValue'
                },
                output: 'vast'
              }
            });
            invokeVideoPlayer(videoUrl, elId);
          }

          if (elementIdsArray.indexOf('video2') !== -1) {
            elId = 'video2';
            var videoUrl = pbjs.adServers.dfp.buildVideoUrl({
              adUnit: videoAdUnit1,
              params: {
                iu: '/19968336/prebid_cache_video_adunit',
                cust_params: {
                  section: 'blog',
                  anotherKey: 'anotherValue'
                },
                output: 'vast'
              }
            });

            invokeVideoPlayer(videoUrl, elId);
          }

          if (elementIdsArray.indexOf('video3') !== -1) {
            elId = 'video3';
            var videoUrl = pbjs.adServers.dfp.buildVideoUrl({
              adUnit: videoAdUnit1,
              params: {
                iu: '/19968336/prebid_cache_video_adunit',
                cust_params: {
                  section: 'blog',
                  anotherKey: 'anotherValue'
                },
                output: 'vast'
              }
            });
            invokeVideoPlayer(videoUrl, elId);
          }
        }
      });
    });
  </script>
</head>
<body>
  <div>
    <video id="video1" data-account="5530036758001" data-player="HJMTvh2YZ" data-embed="default" data-application-id class="video-js" playsinline controls width="640" height="480"></video>
  </div>
  <div>
    <video id="video2" data-account="1752604059001" data-player="B1xXFuBodW" data-embed="default" data-application-id class="video-js" playsinline controls width="640" height="480"></video>
  </div>
  <div>
    <video id="video3" data-account="1752604059001" data-player="SJ5OoOgOb" data-embed="default" data-application-id class="video-js" playsinline controls width="640" height="480"></video>
  </div>

  <script src="//players.brightcove.net/5530036758001/HJMTvh2YZ_default/index.min.js"></script>
  <script src="//players.brightcove.net/1752604059001/B1xXFuBodW_default/index.min.js"></script>
  <script src="https://players.brightcove.net/1752604059001/SJ5OoOgOb_default/index.min.js"></script>
  <script src="//players.brightcove.net/videojs-ima3/2/videojs.ima3.min.js"></script>

  <script type="text/JavaScript">
    function invokeVideoPlayer(url, id) {
      bc(id).ima3({
        serverUrl: url,
        debug: true,
        timeout: 5000,
        ima3SdkSettings: {
            "disableCustomPlaybackForIOS10Plus": true
          },
          adTechOrder: [
            "html5",
            "flash"
          ],
      });

      videojs(id).ready(function() {
        var myPlayer = this;
        var video;

        switch (id) {
          case 'video1':
            video = '5530880848001';
            break;
          case 'video2':
            video = '4825279519001';
            break;
          case 'video3':
            video = '4607357817001';
            break;
          default:
        }

        myPlayer.catalog.getVideo(video, function(error, video){
          myPlayer.catalog.load(video);
          if(error) {
            console.log("There was an error retrieving the media file: " + error);
          }
        });

        myPlayer.on("ima3error", function() {
          console.log("There was an ima3 error.");
        });
      });
    };

    if (tempTag) {
      invokeVideoPlayer(tempTag);
      tempTag = false;
    }
  </script>
</body>
</html>